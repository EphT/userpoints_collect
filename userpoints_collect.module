<?php

/**
 * @file
 * Provides a block for users to collect points within time constraints.
 */


/**
 * Implements hook_permission().
 */
function userpoints_collect_permission() {
  return array(
    'use userpoints collect' => array(
      'title' => t('use userpoints collect'),
      'description' => t('Allows users to use the userpoints collect block.'),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function userpoints_collect_theme() {
  return array(
    'userpoints_collect_form' => array(
      'render element' => 'form',
      'template' => 'userpoints-collect-form'
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function userpoints_collect_block_info() {
  return array(
    'userpoints_collect' => array(
      'info' => t('Userpoints Collect'),
      'cache' => DRUPAL_NO_CACHE,
    ),
  );
}

/**
 * Implements hook_block_view().
 */
function userpoints_collect_block_view($delta = '') {
  switch ( $delta ) {
    case 'userpoints_collect':
      if ( user_is_logged_in() ) {
        return array(
          'content' => drupal_get_form('userpoints_collect_form'),
        );
      }
  }
}

/**
 * Returns a Userpoints collect form.
 */
function userpoints_collect_form($form, &$form_state) {
  $access = userpoints_collect_access();

  $form['submit'] = array(
    '#disabled' => !$access,
    '#type' => 'submit',
    '#value' => $access ? t('Collect Now') : t('Not Available'),
  );

  return $form;
}

/**
 * Validate a Userpoints collect form submission.
 */
function userpoints_collect_form_validate($form, &$form_state) {
  //drupal_set_message(__FUNCTION__);
}

/**
 * Process a Userpoints collect form submission.
 */
function userpoints_collect_form_submit($form, &$form_state) {
  userpoints_collect_add(array(
    'uid' => $GLOBALS['user']->uid,
    'points' => 1,
  ));
}

/**
 * Determine whether the user has access to collect userpoints.
 *
 * @param $account
 *   (optional) The account to check, if not given use currently logged in user.
 * @return
 *   Boolean TRUE if the account has the requested permission.
 */
function userpoints_collect_access($account = NULL) {
  global $user;

  if ( !isset($account) ) {
    $account = $user;
  }

  // User #1 has privileges.
  if ( $account->uid == 1 ) {
    return TRUE;
  }

  // Check if account has permission and is eligible to collect.
  if ( user_access('use userpoints collect', $account) && userpoints_collect_eligible($account) ) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Returns whether a user is eligible to collect a point.
 *
 * @param $account
 *   A user object.
 * @return
 *   Boolean TRUE if the account is eligible.
 */
function userpoints_collect_eligible($account = NULL) {
  $last_txns = drupal_static(__FUNCTION__, array());

  if ( !isset($account) ) {
    global $user;
    $account = $user;
  }

  // Load the last transaction by user.
  if ( !isset($last_txns[$account->uid]) ) {
    $last_txns[$account->uid] = db_query("SELECT * FROM {userpoints_txn} WHERE uid = :uid ORDER BY time_stamp DESC LIMIT 1", array(':uid' => $account->uid))->fetchObject();
  }

  $last_txn = $last_txns[$account->uid];

  // No transaction? User is eligible.
  if ( !$last_txn ) {
    return TRUE;
  }
  // Check transaction and make sure it falls into the eligible period.
  else {
    $last_timestamp = $last_txn->time_stamp;

    /*
    // Eligible period is 00:00:00 plus one day.
    $eligibility_period_min = mktime(0, 0, 0);
    $eligibility_period_max = mktime(0, 0, 0) + 86400;

    if ( $last_timestamp > $eligibility_period_min && $last_timestamp < $eligibility_period_max ) {
      return FALSE;
    }
    else {
      return TRUE;
    }
    */

    if ( $last_timestamp + 60 < time() ) {
      return TRUE;
    }
    else {
      return FALSE;
    }
  }

  // Something went wrong.
  return FALSE;
}

/**
 * Add points for a user.
 */
function userpoints_collect_add($params) {
  if ( userpoints_collect_access(user_load($params['uid'])) ) {
    return userpoints_userpointsapi($params);
  }

  return array(
    'status' => FALSE,
    'reason' => t('User is not eligible.'),
  );
}

/**
 * Returns an array of possible collect restriction periods.
 */
function userpoints_collect_eligible_periods() {
  return array(
    NULL => 'Never',
    60 => '1 minute',
    300 => '5 minutes',
    600 => '10 minutes',
    900 => '15 minutes',
    1800 => 'Half hour',
    3600 => 'One hour',
    86400 => 'One Day',
    604800 => 'One Week',
    1209600 => 'Two Weeks',
    2419200 => 'Four Weeks',
    31536000 => '365 Days',
  );
}

/**
 * Process variables for userpoints-collect-form.tpl.php
 *
 * The $variables array contains the following arguments:
 * - $form
 *
 * @see userpoints-collect-block-form.tpl.php
 */
function template_preprocess_userpoints_collect_form(&$variables) {
  $variables['userpoints_collect'] = array();
  foreach ( element_children($variables['form']) as $key ) {
    $variables['userpoints_collect'][$key] = drupal_render($variables['form'][$key]);
  }

  $variables['userpoints_collect_form'] = implode($variables['userpoints_collect']);
}
